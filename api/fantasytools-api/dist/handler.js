parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"K8v7":[function(require,module,exports) {
"use strict";var e=o(require("jsonwebtoken"));function o(e){return e&&e.__esModule?e:{default:e}}const n=process.env.AUTH0_CLIENT_ID,r=process.env.AUTH0_CLIENT_PUBLIC_KEY,t=(e,o)=>({principalId:e,policyDocument:{Version:"2012-10-17",Statement:[{Action:"execute-api:Invoke",Effect:"Allow",Resource:"*"}]},context:{id:e,email:o}}),l=async o=>{try{console.log(JSON.stringify(o,null,2));const c=o.authorizationToken.replace("Bearer ","");console.log(c);const s={audience:n};console.log(n),console.log(r);const i=await new Promise((o,n)=>{e.default.verify(c,r,s,(e,r)=>{e?n(e):o(r)})});console.log(JSON.stringify(i,null,2));const u=t(i.sub,i.email);return console.log(JSON.stringify(u,null,2)),u}catch(l){throw console.error(l),new Error("Unauthorized")}};module.exports.authorizer=l;
},{}],"fh9A":[function(require,module,exports) {
"use strict";var e=a(require("aws-sdk/clients/dynamodb")),t=a(require("uuid/v4"));function a(e){return e&&e.__esModule?e:{default:e}}const s=new e.default.DocumentClient,u=async e=>{await s.put({TableName:process.env.USERS_TABLE,Item:{id:(0,t.default)(),email:e}}).promise()};module.exports.addEmail=(async e=>{console.log(JSON.stringify(e,null,2));const{body:t}=e,{email:a}=JSON.parse(t);return a?(await u(a),{statusCode:201}):{statusCode:400}});
},{}],"dP3O":[function(require,module,exports) {
"use strict";var e=r(require("aws-sdk/clients/dynamodb")),t=r(require("uuid/v4"));function r(e){return e&&e.__esModule?e:{default:e}}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(r,!0).forEach(function(t){u(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const c=new e.default.DocumentClient,s=async e=>{await c.put({TableName:process.env.USERS_TABLE,Item:o({id:(0,t.default)()},e)}).promise()};module.exports.createUser=(async e=>{console.log(JSON.stringify(e,null,2));const{body:t}=e,{user:r}=JSON.parse(t);return r?(await s(r),{statusCode:201}):{statusCode:400}});
},{}],"fqig":[function(require,module,exports) {
"use strict";var e=t(require("aws-sdk/clients/dynamodb"));function t(e){return e&&e.__esModule?e:{default:e}}const s=new e.default.DocumentClient,o=async e=>{const t=await s.query({TableName:process.env.USERS_TABLE,IndexName:"emailIndex",ExpressionAttributeValues:{":email":e},KeyConditionExpression:"email = :email"}).promise();if(console.log(t),0===t.Items.length)throw new Error("User doesn't exist",e);return t.Items[0]};module.exports.getUser=(async e=>{console.log(JSON.stringify(e)),console.log(JSON.stringify(e.requestContext.authorizer));const{email:t}=e.requestContext.authorizer,s=await o(t);return console.log(JSON.stringify(s)),{statusCode:200,body:JSON.stringify(s)}}),module.exports.getUserByEmail=o;
},{}],"o8ip":[function(require,module,exports) {
"use strict";var e=a(require("aws-sdk/clients/dynamodb")),t=a(require("aws-sdk/clients/kms")),r=a(require("axios")),n=require("./getUser");function a(e){return e&&e.__esModule?e:{default:e}}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(r,!0).forEach(function(t){i(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const c=new e.default.DocumentClient,u=new t.default,l=async e=>{const t=(await r.default.post("https://registerdisney.go.com/jgc/v6/client/ESPN-ONESITE.WEB-PROD/api-key?langPref=en-US",null,{headers:{accept:"application/json"}})).headers["api-key"];return await r.default.post("https://registerdisney.go.com/jgc/v6/client/ESPN-ONESITE.WEB-PROD/guest/login?langPref=en-US",{loginValue:e.username,password:e.password},{headers:{"Content-Type":"application/json",Authorization:`APIKEY ${t}`}})},p=async(e,t)=>{const r=await(0,n.getUserByEmail)(e),a={KeyId:"5a138b9f-ba41-42c7-afda-e8c7c7ec9830",Plaintext:JSON.stringify(t)},o=await u.encrypt(a).promise();r.syncedAccount=o.CiphertextBlob.toString("base64"),await c.put({TableName:process.env.USERS_TABLE,Item:s({},r)}).promise()};module.exports.syncAccount=(async e=>{const{body:t}=e,r=JSON.parse(t),{email:n}=e.requestContext.authorizer;try{await l(r)}catch(a){return console.error("Unable to login with provided credentials",a),{statusCode:403}}return await p(n,r),{statusCode:200}});
},{"./getUser":"fqig"}],"VH3E":[function(require,module,exports) {
"use strict";var e=n(require("aws-sdk/clients/dynamodb")),t=require("./getUser");function n(e){return e&&e.__esModule?e:{default:e}}const o=new e.default.DocumentClient,r=async e=>{const n=await(0,t.getUserByEmail)(e);n.isOnboardingComplete=!0,await o.put({TableName:process.env.USERS_TABLE,Item:n}).promise()};module.exports.onboarding=(async e=>{try{console.log(JSON.stringify(e,null,2));const{email:n}=e.requestContext.authorizer;return await r(n),{statusCode:200}}catch(t){return console.error("Unable to update onboarding",t),{statusCode:500}}});
},{"./getUser":"fqig"}],"lNEe":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"addEmail",{enumerable:!0,get:function(){return e.addEmail}}),Object.defineProperty(exports,"createUser",{enumerable:!0,get:function(){return r.createUser}}),Object.defineProperty(exports,"getUser",{enumerable:!0,get:function(){return t.getUser}}),Object.defineProperty(exports,"getUserByEmail",{enumerable:!0,get:function(){return t.getUserByEmail}}),Object.defineProperty(exports,"syncAccount",{enumerable:!0,get:function(){return n.syncAccount}}),Object.defineProperty(exports,"onboarding",{enumerable:!0,get:function(){return o.onboarding}});var e=require("./addEmail"),r=require("./createUser"),t=require("./getUser"),n=require("./syncAccount"),o=require("./onboarding");
},{"./addEmail":"fh9A","./createUser":"dP3O","./getUser":"fqig","./syncAccount":"o8ip","./onboarding":"VH3E"}],"WEYa":[function(require,module,exports) {
"use strict";var e=o(require("aws-sdk/clients/kms")),t=o(require("axios")),n=o(require("aws-sdk/clients/dynamodb")),r=require("../user");function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(n,!0).forEach(function(t){i(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const c=new e.default,l=new n.default.DocumentClient,u=async(e,t)=>{console.log("Saving Session",e,t);const n=a({},e,{session:a({},t,{lastUpdatedTimestamp:(new Date).toISOString()})});console.log("Saving Item",n),await l.put({TableName:process.env.USERS_TABLE,Item:n}).promise(),console.log("Item saved")},p=async e=>{const n=(await t.default.post("https://registerdisney.go.com/jgc/v6/client/ESPN-ONESITE.WEB-PROD/api-key?langPref=en-US",null,{headers:{accept:"application/json"}})).headers["api-key"];return await t.default.post("https://registerdisney.go.com/jgc/v6/client/ESPN-ONESITE.WEB-PROD/guest/login?langPref=en-US",{loginValue:e.username,password:e.password},{headers:{"Content-Type":"application/json",Authorization:`APIKEY ${n}`}})},d=async e=>{const t=await(0,r.getUserByEmail)(e);if(t.session)return console.log("Using cached Session"),t.session;const n=await c.decrypt({CiphertextBlob:Buffer.from(t.syncedAccount,"base64")}).promise(),o=JSON.parse(n.Plaintext.toString("ascii")),s=await p(o);console.log(JSON.stringify(s.data));const a={swid:s.data.data.profile.swid,s2:s.data.data.s2};return await u(t,a),a};module.exports={fetchSyncedAccountAuthentication:async e=>{const{email:t}=e.requestContext.authorizer;try{const e=await d(t);return{statusCode:200,body:JSON.stringify(e)}}catch(n){return console.error("Unable to fetch auth data",n),{statusCode:500}}},getSyncedAccountCookiesByEmail:d,loginToEspn:p};
},{"../user":"lNEe"}],"mNgy":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"authorizer",{enumerable:!0,get:function(){return e.authorizer}}),Object.defineProperty(exports,"fetchSyncedAccountAuthentication",{enumerable:!0,get:function(){return t.fetchSyncedAccountAuthentication}}),Object.defineProperty(exports,"getSyncedAccountCookiesByEmail",{enumerable:!0,get:function(){return t.getSyncedAccountCookiesByEmail}}),Object.defineProperty(exports,"loginToEspn",{enumerable:!0,get:function(){return t.loginToEspn}});var e=require("./authorizer"),t=require("./fetchSyncedAccountAuthentication");
},{"./authorizer":"K8v7","./fetchSyncedAccountAuthentication":"WEYa"}],"ssY8":[function(require,module,exports) {
"use strict";var e=s(require("axios")),t=require("../authentication");function s(e){return e&&e.__esModule?e:{default:e}}const a=async(s,a,i="2019")=>{const{s2:o,swid:n}=await(0,t.getSyncedAccountCookiesByEmail)(s),r=`espn_s2=${o}; swid=${n}`,u=await e.default.get(`https://fantasy.espn.com/apis/v3/games/ffl/seasons/${i}/segments/0/leagues/${a}?view=mMatchupScore&view=mStatus&view=mSettings&view=mTeam&view=modular&view=mNav`,{headers:{Cookie:r}});return console.log(JSON.stringify(u.data)),u.data};module.exports.fetchLeague=(async e=>{console.log(JSON.stringify(e));const{email:t}=e.requestContext.authorizer,{leagueId:s,seasonId:i}=e.pathParameters,o=await a(t,s,i);return{statusCode:200,body:JSON.stringify(o)}});
},{"../authentication":"mNgy"}],"AgN0":[function(require,module,exports) {
"use strict";var e=s(require("axios")),t=require("../authentication");function s(e){return e&&e.__esModule?e:{default:e}}const a=async s=>{const{s2:a,swid:i}=await(0,t.getSyncedAccountCookiesByEmail)(s),o=`espn_s2=${a}; swid=${i}`,n=await e.default.get(`https://fan.api.espn.com/apis/v2/fans/${i}`,{headers:{Cookie:o}});return console.log(JSON.stringify(n.data)),n.data};module.exports.fetchLeagues=(async e=>{console.log(JSON.stringify(e));const{email:t}=e.requestContext.authorizer,s=await a(t);return{statusCode:200,body:JSON.stringify(s)}});
},{"../authentication":"mNgy"}],"o9mP":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"fetchLeague",{enumerable:!0,get:function(){return e.fetchLeague}}),Object.defineProperty(exports,"fetchLeagues",{enumerable:!0,get:function(){return t.fetchLeagues}});var e=require("./fetchLeague"),t=require("./fetchLeagues");
},{"./fetchLeague":"ssY8","./fetchLeagues":"AgN0"}],"jr5P":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"authorizer",{enumerable:!0,get:function(){return e.authorizer}}),Object.defineProperty(exports,"fetchSyncedAccountAuthentication",{enumerable:!0,get:function(){return e.fetchSyncedAccountAuthentication}}),Object.defineProperty(exports,"loginToEspn",{enumerable:!0,get:function(){return e.loginToEspn}}),Object.defineProperty(exports,"fetchLeague",{enumerable:!0,get:function(){return t.fetchLeague}}),Object.defineProperty(exports,"fetchLeagues",{enumerable:!0,get:function(){return t.fetchLeagues}}),Object.defineProperty(exports,"addEmail",{enumerable:!0,get:function(){return r.addEmail}}),Object.defineProperty(exports,"createUser",{enumerable:!0,get:function(){return r.createUser}}),Object.defineProperty(exports,"getUser",{enumerable:!0,get:function(){return r.getUser}}),Object.defineProperty(exports,"syncAccount",{enumerable:!0,get:function(){return r.syncAccount}}),Object.defineProperty(exports,"onboarding",{enumerable:!0,get:function(){return r.onboarding}});var e=require("./authentication"),t=require("./league"),r=require("./user");
},{"./authentication":"mNgy","./league":"o9mP","./user":"lNEe"}]},{},["jr5P"], null)
//# sourceMappingURL=/handler.js.map